# Changelog

All notable changes to Bing Wallpaper Now will be documented in this file.

## 1.2.1

### Fixed

- 修复设置弹窗在小屏幕或内容较多时因 flex 居中导致顶部溢出不可达的问题，改用 auto margin 居中方案

## 1.2.0

### Added

- 开发版本（如 1.1.5-0）现在能正确检测到对应正式版（1.1.5）的发布，不再被视为同版本跳过

### Changed

- 后端代码大规模重构：`lib.rs` 从 ~2700 行拆分至 ~300 行
  - 按领域拆分为独立模块：`version_check`、`tray`、`transfer`、`update_cycle`、`auto_update`
  - 命令层按领域目录化：`commands/settings`、`commands/wallpaper`、`commands/window`、`commands/storage`、`commands/mkt`
  - `models.rs` 拆分为 `models/` 子模块目录（bing、wallpaper、index、settings、runtime）
  - `download_wallpaper_if_needed` 迁入 `download_manager` 模块
- 前端组件模块化：从 `App.tsx` 和 `Settings.tsx` 提取独立 hooks 和工具函数
  - 新增 `useUpdateCheck`、`useTrayEvents` hooks
  - 新增 `transferHelpers` 工具模块

### Fixed

- 修复 `get_effective_mkt` 同时持有两把异步锁的潜在死锁风险，改为顺序获取并立即释放
- 更新循环的并发保护标志（`update_in_progress`）改为单点重置模式，消除遗漏重置的风险

### Testing

- 新增前端事件链路回归测试：`useUpdateCheck`（11 项）、`useTrayEvents`（6 项）、`transferHelpers`（11 项）
- 在 `AGENTS.md` 中记录 6 条关键跨模块事件链路，作为手动回归检查清单

## 1.1.5

### Fixed

- 手动触发"检查更新"发现新版本时，自动弹出主窗口显示更新提示，无需用户手动打开
  - 后台自动检查更新不受影响，仍保持静默

## 1.1.4

### Changed

- 🔐 **macOS 构建强制代码签名**
  - 本地和 CI 构建均使用固定的开发者签名身份，拒绝产出未签名或 ad-hoc 签名的包
  - CI 构建自动启用 Hardened Runtime
  - 新增构建后签名验证步骤，检测到 unsigned/ad-hoc 时构建失败
- 🔧 **CI 发布工作流健壮性改进**
  - 移除 `jq` 不可用时的 `sed` fallback 分支，缺失直接报错
  - 修复签名 patch 步骤在非 macOS 平台误执行导致构建失败的问题
- 🛠️ **版本管理命令支持免交互执行**
  - `make patch/minor/major` 支持 `YES=1` 跳过确认提示

## 1.1.3

### Fixed

- 🖥️ **macOS Dock 图标双重保障**
  - 在 `LSUIElement=true` 基础上，启动时一次性调用 `setActivationPolicy(Accessory)`
  - 解决某些场景下 `Info.plist` 声明不足以阻止 Dock 运行状态点出现的问题

### Changed

- 🔧 **CI/CD 发布工作流优化**
  - Release body 生成改用 `env` 段传递环境变量，移除临时文件中转
- 📦 **依赖更新**
  - 更新 `@typescript-eslint` 系列至 8.56.1
  - 更新多个 Rust 依赖至最新版本

## 1.1.2

### Changed

- 🔧 **CI/CD 流程优化**
  - CI 补齐前端测试、Prettier 格式检查和 Markdown lint，与本地 `make check` 完全对齐
  - 简化 pnpm 缓存逻辑，改用 `setup-node` 内置缓存替代手动 `actions/cache`
  - 升级 `actions/checkout` v5 → v6
  - Rust CI 命令添加 `--locked` flag，保证可复现构建
  - 发布构建启用 thin LTO，改善产物体积和运行效率
  - 所有 job 添加 `timeout-minutes`，防止卡死浪费 runner 时间
  - 移除无效的 `workflow_dispatch` 触发器
  - 修复 `find` 命令 `-o` 优先级问题

## 1.1.1

### Changed

- 🔧 **质量检查流程优化**
  - `make check` 新增 `NO_FIX=1` strict 模式，仅检查不自动修复
  - 发布流程（`make release`）内部自动使用 strict 模式，避免 auto-fix 污染工作区
  - 新增 `make fix` 一键修复所有格式和 lint 问题
  - 精简发布和审查的 checklist，去除与主流程重复的内容

## 1.1.0

### Added

- 📦 **数据导入/导出功能**
  - 新增壁纸数据导入和导出功能，用户可在设备间迁移壁纸收藏
  - 支持选择目标目录进行数据导出，包含壁纸图片和元数据索引
  - 支持从外部目录导入壁纸数据，自动合并到本地收藏
  - 导入/导出过程中显示加载状态和结果反馈
  - 新增中英文翻译支持

### Changed

- 🔧 **构建与质量检查流程优化**
  - Makefile 新增 `test`、`build`、`clean-all` 等便捷目标
  - 统一发布和审查的预检脚本为 `scripts/precheck.sh`
  - 版本管理脚本改用 `jq` 进行 JSON 操作，提升可靠性
  - 新增 `make retag` 支持重新触发 CI/CD 构建

### Testing

- ✅ **新增导入/导出测试覆盖**
  - 新增 Settings 组件导入/导出功能完整测试用例
  - 覆盖成功、失败、部分成功等场景

## 1.0.1

### Changed

- 🖥️ **macOS Dock 图标行为优化**
  - 使用 `Info.plist` 的 `LSUIElement=true` 系统级声明隐藏 Dock 图标，替代运行时
    `setActivationPolicy` 切换方案
  - 移除 `macos_app.rs` 模块及所有运行时 activation policy 调用
  - 彻底解决点击 Dock 图标后出现运行状态小圆点的问题

- 🔧 **简化窗口事件处理**
  - 精简 `on_window_event` 处理逻辑，仅保留 `CloseRequested` 事件处理
  - 移除冗余的 `Focused` 事件处理和 `unminimize` 调用

### Docs

- 📝 **AGENTS.md 文档增强**
  - 新增"遇到问题先搜索"开发指导原则
  - 补充 macOS Dock 图标和增量编译问题的排查方案
  - 新增 `Info.plist` 文件说明和平台特定行为文档

## 1.0.0

### Added

- 🌍 **Bing 市场（mkt）独立选择**
  - 壁纸来源市场与 UI 语言解耦，用户可独立选择 Bing 壁纸市场
  - 支持 38 个市场，覆盖亚太、欧洲、美洲、非洲四大区域
  - 设置面板新增市场下拉选择器，按区域分组显示
  - 当 Bing 实际返回的市场与用户选择不同时，显示 mismatch 告警提示

- 🔄 **市场状态统一接口**
  - 新增 `MarketStatus` 结构体，收敛 mkt 相关状态为单一语义清晰的接口
  - 持久化 `last_actual_mkt`，解决重启后因 mkt 不匹配导致读不到壁纸的问题

### Changed

- 🏗️ **架构升级至 1.0**
  - 索引版本从 v4 升级至 v5，`wallpapers_by_language` 重命名为 `mkt`
  - 自动迁移 v4 索引，备份旧文件为 `index.json.v4.bak`
  - Node.js 最低版本提升至 25

- 🔧 **代码质量改进**
  - 改进 App 组件和 index manager 的错误处理
  - 优化代码格式和结构

### Testing

- ✅ **大幅提升测试覆盖率**
  - 前端测试从 163 个增长至 201 个（+23%），覆盖率从 89% 提升至 93%
  - 后端测试从 76 个增长至 115 个（+51%）
  - 新增 `taglines.ts`、`layout.ts` 测试文件，实现 100% 覆盖
  - 新增 `WallpaperIndex` 全方法单测、`get_market_groups` 结构验证、`can_skip_api_request` 逻辑测试
  - 补充 ThemeContext、I18nContext、useBingWallpapers 等模块的边界用例

## 0.4.22

### Changed

- 📦 **依赖更新**
  - 更新 vite 从 7.2.6 到 7.2.7，包含最新的构建工具改进

## 0.4.21

### Fixed

- 🖥️ **优化大屏幕笔记本布局显示**
  - 修复 MacBook Pro 16 寸最大化窗口时只显示 3 列的问题
  - 将 4K 断点从 1920px 降低至 1400px，使大屏幕笔记本能正确显示 4 列壁纸
  - 优化响应式布局，提升大屏幕设备的显示体验

## 0.4.20

### Fixed

- 🔧 **修复版本检查功能**
  - 修复 GitHub API 响应反序列化问题
  - 正确处理 `browser_download_url` 字段，即使该字段缺失也不会导致版本检查失败
  - 使用 `skip_deserializing` 替代 `skip`，确保反序列化的健壮性

## 0.4.19

### Added

- 🖥️ **竖屏显示器支持**
  - 新增屏幕方向检测功能，自动识别横屏和竖屏显示器
  - 为竖屏显示器自动下载竖屏壁纸（1080x1920 分辨率）
  - 横屏显示器继续使用 UHD 版本壁纸
  - 竖屏壁纸文件命名格式：`{end_date}r.jpg`（更简洁）
  - 支持按需下载竖屏壁纸，如果文件不存在会自动下载
  - 根据屏幕方向为每个显示器智能设置对应的壁纸

- 🔧 **代码质量改进**
  - 修复所有 Clippy 警告
  - 移除所有 `#[allow]` 注释，彻底解决代码质量问题
  - 优化代码结构，提升可维护性

## 0.4.18

### Changed

- 🔧 **优化图片下载校验机制**
  - 移除 MD5 哈希校验，改用更高效的图片格式验证方式
  - 使用 Content-Length 校验文件大小完整性
  - 使用图片格式解析验证文件有效性，确保下载的图片可以正常使用
  - 简化下载逻辑，提升下载性能

- 📦 **依赖更新**
  - 更新 vitest 从 4.0.13 到 4.0.14
  - 更新 prettier 从 3.6.2 到 3.7.1
  - 更新 Rust 依赖 borsh、endi、winnow、tracing 等到最新版本
  - 移除未使用的 md5 依赖

## 0.4.17

### Added

- 🔒 **图片下载哈希校验**
  - 添加图片下载后的 MD5 哈希值校验功能，确保下载文件的完整性
  - 自动从 Bing API 获取哈希值并在下载完成后进行校验
  - 如果哈希值不匹配，会自动删除损坏的文件并重新下载
  - 支持对已存在文件的哈希值验证，确保文件未被损坏

## 0.4.16

### Changed

- 📦 **依赖更新**
  - 更新项目依赖以包含最新的安全修复和性能改进
  - 升级 Tauri 相关组件以保持与最新版本兼容

## 0.4.15

### Fixed

- 🎨 **Windows 托盘图标显示优化**
  - 修复 Windows 托盘图标显示过小的问题
  - 为 Windows 平台创建专用的完整大小托盘图标（tray-icon-windows.png）
  - 确保 Windows 托盘图标使用无缩放的完整大小图标，提升显示清晰度
  - macOS 托盘图标保持不变，继续使用原有的适配方案

### Changed

- 🔧 **图标生成流程优化**
  - 创建 `icon-windows.svg`（无缩放版本）专门用于 Windows 平台
  - 改进图标生成脚本，为不同平台使用不同的 SVG 源文件
  - Windows 使用完整大小的 `icon-windows.svg` 生成图标
  - macOS 继续使用带 0.75 缩放的 `icon.svg` 生成图标
  - 优化生成流程，确保各平台图标大小适配正确

## 0.4.14

### Changed

- 🎨 **应用图标优化**
  - 优化应用图标设计，缩小图标内容以留出更多边距，提升视觉效果
  - 使用 Tauri CLI 统一生成各平台图标，简化图标管理流程
  - 改进图标生成脚本，移除不必要的依赖

- 🔧 **构建配置优化**
  - macOS 签名配置优化，默认使用临时签名（ad-hoc signing）
  - CI/CD 中要求必须配置正式签名身份，确保生产构建使用正式签名
  - 改进错误提示，明确说明签名配置要求

### Fixed

- 📝 **文档和代码质量**
  - 修复 Markdown lint 问题，添加 markdownlint 配置文件
  - 优化文档格式，提升可读性

## 0.4.13

### Fixed

- 🎨 **macOS Menu Bar 图标适配**
  - 修复 macOS Menu Bar 图标在深色模式下无法自动切换的问题
  - 现在图标会根据系统深色/浅色模式自动调整颜色
  - 提升在深色模式下的视觉体验

## 0.4.12

### Added

- ✨ **系统通知功能**
  - 使用系统原生通知替换浏览器 alert() 弹窗，提供更好的用户体验
  - 壁纸设置成功、文件夹打开失败等操作都会显示系统通知
  - 手动检查更新时，如果没有新版本可用，会显示系统通知提示

- ⌨️ **键盘快捷键支持**
  - 按 `Esc` 键可快速关闭设置、关于和更新对话框
  - 按 `Cmd/Ctrl + ,` 可快速打开设置窗口
  - 提升操作效率，改善用户体验

- 🔄 **托盘菜单增强**
  - 在托盘菜单中添加"检查更新"选项，方便用户手动检查新版本
  - 优化菜单项顺序，将"关于"放在"检查更新"下方

### Changed

- 🎨 **UI 改进**
  - 优化按钮的视觉反馈效果，添加过渡动画和加载状态
  - 改进空状态显示，添加图标提示
  - 调整深色模式下的边框和阴影效果，降低视觉亮度

- 🧹 **代码清理**
  - 删除未使用的 Toast 组件及相关文件
  - 优化键盘快捷键事件监听器的依赖数组，提升性能

- 🔧 **错误处理改进**
  - 改进 Rust 事件发射的错误处理，添加详细的日志记录
  - 提升错误追踪能力，便于问题排查

### Testing

- ✅ **测试覆盖增强**
  - 添加系统通知工具函数的完整测试
  - 添加键盘快捷键功能的测试
  - 添加检查更新事件监听器的测试
  - 提升代码质量和可靠性

## 0.4.11

### Changed

- ⚡ **优化应用启动性能**
  - 合并重复的运行时状态加载，减少启动时的文件 I/O 操作
  - 提升应用启动速度，改善用户体验

- 🔧 **改进代码质量**
  - 提取自启动通知标志设置逻辑为可重用函数
  - 改进错误处理，提供更详细的日志信息
  - 优化代码结构，提升可维护性

## 0.4.10

### Fixed

- 🐛 **修复自启动状态同步问题**
  - 修复应用启动时自启动状态与系统设置不一致的问题
  - 添加启动时自动同步系统自启动状态的功能
  - 即使用户手动在系统设置中修改了自启动状态，应用也能正确获取并同步

### Changed

- 🔧 **改进自启动通知跟踪**
  - 添加 `autostart_notification_shown` 字段，记录用户是否已查看过 macOS 系统自启动通知
  - 改进错误处理，当读取自启动状态失败时提供更详细的日志信息
  - 提升自启动功能的状态管理准确性

## 0.4.9

### Changed

- 🔧 **改进发布流程**
  - 修复 release 标签创建逻辑，确保标签正确指向版本更新提交
  - 提升发布流程的可靠性和一致性

## 0.4.8

### Changed

- 🔧 **优化版本检查时机**
  - 将启动时的版本检查延迟从 2 秒调整为 60 秒
  - 避免在应用启动时立即发起网络请求，提升启动性能
  - 让用户有足够时间使用应用后再进行版本检查

## 0.4.7

### Added

- ✨ **应用启动时自动检查更新**
  - 应用启动时自动检测是否有新版本可用
  - 智能检测当前操作系统的安装包是否已打包完成，只有 release 版本才提示更新
  - 支持"此版本不再提醒"功能，用户可以选择忽略特定版本
  - 更新提示弹窗提供三个选项：前往更新、此版本不再提醒、关闭

### Changed

- 🔧 **移除设置中的手动检查更新功能**
  - 将版本检查功能从设置页面移除，改为应用启动时自动检查
  - 简化设置界面，提升用户体验

## 0.4.6

### Added

- ✨ **新增版本检查功能**
  - 支持从 GitHub Releases 自动检查新版本
  - 在设置页面添加"检查更新"功能
  - 检测到新版本时显示更新提示和下载链接
  - 支持跳转到 GitHub Releases 页面下载最新版本
  - 提升用户体验，让用户及时了解新版本发布

## 0.4.5

### Changed

- ✨ **改进自动应用壁纸逻辑**
  - 记录用户手动设置壁纸时的最新壁纸信息（按语言隔离）
  - 当自动应用检测到最新壁纸与用户手动设置时的最新壁纸相同时，自动跳过应用
  - 避免用户手动选择壁纸后，自动更新功能又将其改回的情况
  - 提升用户体验，让用户的选择得到尊重

## 0.4.4

### Changed

- 🔧 **优化 API 重试策略**
  - 将 Bing API 重试次数从 10 次降低到 3 次
  - 将最大退避延迟从 60 秒降低到 16 秒
  - 提升失败后的响应速度，减少不必要的等待时间

- 🔧 **优化日志文件管理**
  - 配置自动日志轮转：单个日志文件最大 10MB
  - 使用 KeepOne 策略：保留最新的日志文件
  - 防止日志文件无限增长，节省磁盘空间

- 💬 **改进空状态提示信息**
  - 在壁纸列表为空时，增加 IP 地区提示
  - 提醒用户如果不在目标地区，可能无法获取对应语言的内容
  - 建议用户尝试切换语言设置以获取壁纸

### Fixed

- 🐛 **修复测试代码类型安全问题**
  - 移除所有测试文件中的 `as any` 类型断言
  - Settings.test.tsx: 使用正确的 `vi.fn<FunctionType>()` 模式
  - WallpaperCard.test.tsx: 使用 Tauri 的 `UnlistenFn` 类型
  - ThemeContext.test.tsx: 为模拟事件添加 ESLint 禁用注释
  - main.tsx: 扩展 Window 接口以支持 React DevTools 钩子
  - 提升代码质量和类型安全性

## 0.4.3

### Changed

- ✨ **扩展应用标语库**
  - 中文标语从 10 条扩展至 20 条，提供更丰富的文案选择
  - 新增标语精选自现代文学作品和哲学思辨，语言更加文艺优雅
  - 优化时间段选择机制：早上（6:00-12:00）显示积极向上的文案，下午（12:00-18:00）显示探索发现的文案，晚上（18:00-6:00）显示安静温馨的文案
  - 每天打开应用都能看到不同的启发文字，减少重复感，增强新鲜体验

## 0.4.2

### Changed

- ✨ **更新应用标语内容**
  - 更新中文标语为更具文学性和启发性的句子，选自现代诗人、文学家和流行文化
  - 更新英文标语为经典的理想主义和浪漫主义名句
  - 标语包括来自泰戈尔、汪国真、高晓松、顾城、七堇年、路遥等作者的名言
  - 英文标语包括来自托尔金、王尔德、甘地、乔布斯、丁尼生等作家的经典语句
  - 提升用户体验，每次打开应用都能看到鼓舞人心的文字

## 0.4.1

### Changed

- 🔧 **优化"自动应用新壁纸"功能**
  - 将设置名称从"自动更新壁纸"改为"自动应用新壁纸"，更准确地反映功能
  - 关闭时：仍会自动获取新壁纸，但不会自动应用，需要手动点击设置
  - 开启时：自动获取新壁纸，并在检测到更新的壁纸时自动应用该壁纸
  - 提升用户体验，让用户更好地控制壁纸的自动应用行为

### Fixed

- 🐛 **修复图片加载路径问题**
  - 修复壁纸目录未加载完成时导致的 asset protocol 路径错误
  - 添加路径验证，确保只在有效路径时才调用 convertFileSrc
  - 修复空路径时的错误处理，避免无效的相对路径

- 🐛 **修复错误消息国际化**
  - 修复"无法获取壁纸目录"错误消息的国际化问题
  - 添加对应的英文翻译，确保多语言支持完整

## 0.4.0

### Changed

- 🔧 **索引格式优化（v4）**
  - 索引版本从 v3 升级到 v4
  - 使用短字段名（t, c, l, d, u）以节省存储空间
  - 使用紧凑 JSON 格式（无格式化），进一步减小文件大小
  - 索引最大条目数限制提升至 2000（约 5.5 年历史记录）
  - 使用 IndexMap 保持 JSON 序列化时的顺序

- 🗑️ **移除旧版本支持**
  - 移除所有 v3 及更早版本的迁移逻辑
  - 版本不匹配时直接返回空索引，不再创建备份文件
  - 简化代码逻辑，提高可维护性

### Fixed

- 🐛 **修复前端数据格式不匹配问题**
  - 修复后端返回短字段名但前端期望完整字段名的问题
  - 添加数据格式转换函数，自动将后端格式转换为前端格式
  - 修复 React key 警告问题

- 🐛 **修复测试用例**
  - 更新所有测试用例以适配新的数据格式
  - 移除已删除字段（keep_image_count）的测试用例
  - 确保所有测试通过
