---
name: review
description: 审查当前变更并输出高风险问题清单。用于 PR 审查、分支自检、合并前质量门禁与回归风险扫描。
allowed-tools: Read Shell Grep Glob
disable-model-invocation: true
---

# 代码审查

审查当前变更，重点找出高风险问题：功能回归、潜在 bug、架构退化、测试缺失。
结论必须基于本次改动证据，建议必须可执行。

## When to Use

- 用户请求"review / 审查 / 代码评审 / 合并前检查"
- 需要对当前分支相对基线分支的变更做风险扫描
- 需要给出可执行的修复建议和测试缺口清单
- 需要快速判断是否可以合并

## Invocation Mode

- 当前配置为 `disable-model-invocation: true`，仅在显式 `/review` 时生效
- 如果希望模型在相关上下文自动调用，可将其改为 `false` 或删除该字段

## 审查范围

- 仅审查本次变更相关文件
- 包含未提交、已暂存、以及当前分支相对基线分支的差异
- 不扩展到无关模块

## Instructions

1. 先澄清基线分支与审查边界（若不明确）
   - 基线分支通常为 `origin/main`（对比远程，包含本地已提交但未推送的变更）
   - 若用户明确指定基线分支或范围，以用户要求为准

2. 运行自动化检查（前置，必须）
   - 优先执行 `bash scripts/precheck.sh review`
   - 脚本本质执行 `make check`，确保格式、lint、类型检查、测试全部通过
   - 如果不通过，先修复再继续审查

3. 确认变更文件
   - 使用 Git 查看本次改动清单
   - 先识别核心改动，再看关联文件

4. 逐文件审查
   - 读取 `references/review-checklist.md` 获取详细检查项
   - 按"功能与边界 -> 风险 -> 架构 -> 测试"顺序检查

5. 仅输出有证据的问题
   - 不做泛泛建议，不列"可能也许"的无证据猜测
   - 每个问题都要说明影响与建议修复路径

## 优先级

- **关键**：可能导致崩溃、数据丢失、安全问题、明显功能损坏
- **高**：高概率 bug、严重耦合或复杂度问题、关键逻辑缺少测试
- **中**：可维护性问题、可改进但不阻塞合并

## Output Format

按下面结构输出，先问题后总结：

```markdown
## Findings
1. [关键/高/中] `path/to/file` - 问题标题
   - 影响：...
   - 建议：...

## Testing
- 已覆盖：...
- 缺失：...

## Summary
- 总体结论与风险
```

## 审查原则

- 结论必须基于本次改动证据
- 建议要具体、可执行
- 优先简单直接的修复方案
- 若发现关键或高优先级问题，审查结束时主动询问是否需要我直接修复
